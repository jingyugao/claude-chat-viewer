<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Conversation Log - Swimlane View</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #1e1e1e; color: #d4d4d4; font-family: "Menlo", "Monaco", "Courier New", monospace; }
        .bubble { max-width: 90%; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        .swimlane-node {
            transition: all 0.2s ease;
        }
        .swimlane-node:hover {
            transform: scale(1.3);
            z-index: 10;
        }
        .swimlane-lane {
            transition: background-color 0.2s ease;
        }
        .swimlane-lane:hover {
            background-color: rgba(255, 255, 255, 0.02);
        }
    </style>
</head>
<body class="h-screen flex flex-col">
    <div id="root" class="flex-1 overflow-hidden"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const getDataFile = () => {
            const params = new URLSearchParams(window.location.search);
            const candidate = params.get("file");
            if (!candidate) return null;
            if (candidate.includes("/") || candidate.includes("\\") || candidate.includes("..")) {
                return null;
            }
            return candidate;
        };

        // ÊèêÂèñ session ID
        // ÊèêÂèñ agent ÂêçÁß∞Ôºà‰ªé system[2] ‰∏≠ÊèêÂèñËßíËâ≤ÊèèËø∞ÁöÑÂÖ≥ÈîÆËØçÔºâ
        const extractAgentName = (call) => {
            try {
                const system = call.request_body?.system;
                if (Array.isArray(system) && system.length > 2) {
                    const roleText = system[2]?.text || '';
                    // ËØÜÂà´‰∏çÂêåÁöÑ agent Á±ªÂûã
                    if (roleText.includes('analyzing git history')) return 'Git History Analyzer';
                    if (roleText.includes('Summarize this coding conversation')) return 'Conversation Summarizer';
                    if (roleText.includes('new conversation topic')) return 'Topic Analyzer';
                    if (roleText.includes('interactive CLI tool')) return 'Main CLI Tool';
                    // ÈªòËÆ§‰ΩøÁî®Ââç30‰∏™Â≠óÁ¨¶
                    return roleText.substring(0, 30).trim() || 'Unknown Agent';
                }
            } catch(e) {}
            return 'count_tokens';
        };

        // ÊèêÂèñ session IDÔºàÂü∫‰∫é cc_versionÔºâ
        const extractSessionId = (call) => {
            try {
                const system = call.request_body?.system;
                if (system) {
                    const systemText = Array.isArray(system) ? (system[0]?.text || '') : system;
                    const match = systemText.match(/cc_version=([^;]+)/);
                    if (match) {
                        const fullVersion = match[1];
                        return fullVersion.split('.').pop();
                    }
                }
                const uid = call.request_body.metadata?.user_id;
                if (uid && uid.includes("_session_")) {
                    const sessionId = uid.split("_session_")[1];
                    return sessionId.length > 12 ? sessionId.substring(0, 8) + "..." : sessionId;
                }
            } catch(e) {}
            return "unknown";
        };

        // Ëé∑ÂèñË∞ÉÁî®Áä∂ÊÄÅ
        const getCallStatus = (call) => {
            if (!call.response_body) return "pending";
            if (call.response_body.error) return "error";

            const hasToolUse = call.response_body.content?.some(b => b.type === "tool_use");
            if (hasToolUse) return "tool";

            const stopReason = call.response_body.stop_reason;
            if (stopReason === "end_turn") return "success";
            if (stopReason === "max_tokens") return "interrupted";

            return "success";
        };

        // Ëé∑ÂèñÁä∂ÊÄÅÈ¢úËâ≤
        const getStatusColor = (status) => {
            const colors = {
                success: "bg-green-500",
                tool: "bg-blue-500",
                error: "bg-red-500",
                interrupted: "bg-yellow-500",
                pending: "bg-gray-500"
            };
            return colors[status] || colors.pending;
        };

        // Ëé∑ÂèñÁä∂ÊÄÅÂõæÊ†á
        const getStatusIcon = (status) => {
            const icons = {
                success: "‚úì",
                tool: "üõ†",
                error: "‚úó",
                interrupted: "‚è∏",
                pending: "‚óã"
            };
            return icons[status] || icons.pending;
        };

        // Ë∞ÉÁî®ËäÇÁÇπÁªÑ‰ª∂
        const CallNode = ({ call, isActive, onClick, position, sessionColor, vertical = false, horizontalPos = 50 }) => {
            const status = getCallStatus(call);
            const icon = getStatusIcon(status);
            // ‰ΩøÁî®‰º†ÂÖ•ÁöÑ sessionColorÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®Áä∂ÊÄÅÈ¢úËâ≤
            const color = sessionColor || getStatusColor(status);

            const msgCount = call.request_body.messages.length;
            const lastMsg = call.request_body.messages[msgCount - 1];
            let preview = "System";
            if (lastMsg && lastMsg.content) {
                if (typeof lastMsg.content === 'string') preview = lastMsg.content;
                else if (Array.isArray(lastMsg.content)) {
                    const txt = lastMsg.content.find(b => b.type === 'text');
                    preview = txt ? txt.text : '[Tool Result]';
                }
            }

            // ËÆ°ÁÆó‰ΩçÁΩÆÔºåvertical Êó∂‰ΩøÁî®Áã¨Á´ãÁöÑ horizontalPos
            const style = vertical
                ? { top: `${position}%`, left: `${horizontalPos}%`, transform: 'translate(-50%, -50%)' }
                : { left: `${position}%`, top: '50%', transform: 'translate(-50%, -50%)' };

            return (
                <div
                    className="swimlane-node absolute cursor-pointer group"
                    style={style}
                    onClick={onClick}
                    title={`${new Date(call.timestamp * 1000).toLocaleTimeString()} - ${preview.substring(0, 50)}`}
                >
                    <div className={`w-5 h-5 rounded-full ${color} ${isActive ? 'ring-4 ring-white/50' : ''} flex items-center justify-center text-[10px] text-white font-bold shadow-lg`}>
                        {icon}
                    </div>
                    {/* ÊÇ¨ÂÅúÈ¢ÑËßà */}
                    <div className="absolute hidden group-hover:block left-8 top-1/2 -translate-y-1/2 bg-black/90 text-white text-[10px] px-3 py-2 rounded shadow-xl whitespace-nowrap z-20 border border-gray-700 max-w-[300px]">
                        <div className="font-bold text-blue-400 mb-1">Call #{call._sortIdx + 1}</div>
                        <div className="text-gray-400">{new Date(call.timestamp * 1000).toLocaleString()}</div>
                        <div className="mt-1 text-gray-300 truncate">{preview.substring(0, 60)}...</div>
                        <div className="mt-1 text-gray-500">Messages: {msgCount}</div>
                    </div>
                </div>
            );
        };

        // Âçï‰∏™Ê≥≥ÈÅìÁªÑ‰ª∂ÔºàÁ´ñÂêëÔºâ
        const SwimlaneLane = ({ agentName, calls, activeCall, onCallClick, timeRange, globalIndexMap }) => {
            // Ëé∑ÂèñÂÖ®Â±ÄË∞ÉÁî®ÊÄªÊï∞
            const globalTotal = Object.keys(globalIndexMap).length;

            const getGlobalPosition = (sortIdx) => {
                const globalIdx = globalIndexMap[sortIdx];
                if (globalIdx === undefined) return 50;
                if (globalTotal <= 1) return 50;
                return (globalIdx / (globalTotal - 1)) * 100;
            };

            // ‰∏∫ÊØè‰∏™Ë∞ÉÁî®ÂàÜÈÖç session È¢úËâ≤
            const sessionColors = [
                "bg-blue-500",
                "bg-green-500",
                "bg-purple-500",
                "bg-yellow-500",
                "bg-pink-500",
                "bg-cyan-500",
                "bg-orange-500",
                "bg-red-500"
            ];

            // ËØÜÂà´ session ËæπÁïåÔºå‰∏∫Êó∂Èó¥Êà≥Êé•ËøëÁöÑË∞ÉÁî®Ê∑ªÂä†ËΩªÂæÆÂÅèÁßª
            const callsWithSession = useMemo(() => {
                let currentSessionIdx = 0;

                // È¶ñÂÖàËØÜÂà´ session
                const withSession = calls.map((call, idx) => {
                    const msgCount = call.request_body?.messages?.length || 1;
                    const prevMsgCount = idx > 0 ? (calls[idx-1].request_body?.messages?.length || 1) : 0;

                    // Â¶ÇÊûú msg_count ÂáèÂ∞ëÊàñÁõ∏Á≠âÔºåËØ¥ÊòéÊòØÊñ∞ session
                    if (idx > 0 && msgCount <= prevMsgCount) {
                        currentSessionIdx++;
                    }

                    return {
                        ...call,
                        sessionIdx: currentSessionIdx,
                        sessionColor: sessionColors[currentSessionIdx % sessionColors.length]
                    };
                });

                // Ê£ÄÊµãÊó∂Èó¥Êà≥ÈùûÂ∏∏Êé•ËøëÁöÑË∞ÉÁî®ÔºàÂ∞è‰∫é0.5ÁßíÔºâÔºåÁªôÂÆÉ‰ª¨Ê∑ªÂä†ËΩªÂæÆÁöÑÊ∞¥Âπ≥ÂÅèÁßª
                return withSession.map((call, idx) => {
                    let horizontalPos = 50; // ÈªòËÆ§Âú®‰∏≠Èó¥

                    // Ê£ÄÊü•ÂâçÂêéË∞ÉÁî®ÁöÑÊó∂Èó¥Êà≥
                    const prevCall = idx > 0 ? withSession[idx - 1] : null;
                    const nextCall = idx < withSession.length - 1 ? withSession[idx + 1] : null;

                    // ËÆ°ÁÆó‰∏éÂâçÂêéË∞ÉÁî®ÁöÑÊó∂Èó¥Â∑Æ
                    const timeDiffPrev = prevCall ? Math.abs(call.timestamp - prevCall.timestamp) : Infinity;
                    const timeDiffNext = nextCall ? Math.abs(call.timestamp - nextCall.timestamp) : Infinity;

                    // Â¶ÇÊûúÊó∂Èó¥Â∑ÆÂ∞è‰∫é0.5ÁßíÔºåÊ∑ªÂä†ËΩªÂæÆÂÅèÁßª
                    if (timeDiffPrev < 0.5 || timeDiffNext < 0.5) {
                        // Ê†πÊçÆÁ¥¢Âºï‰ΩçÁΩÆËΩÆÊµÅÂÅèÂ∑¶ÊàñÂÅèÂè≥
                        const offset = (idx % 3 - 1) * 8; // -8%, 0%, +8%
                        horizontalPos = 50 + offset;
                    }

                    return {
                        ...call,
                        horizontalPos
                    };
                });
            }, [calls]);

            // Agent ËæπÊ°ÜÈ¢úËâ≤
            const agentColors = {
                "Git History Analyzer": "border-blue-500",
                "Conversation Summarizer": "border-green-500",
                "Topic Analyzer": "border-purple-500",
                "Main CLI Tool": "border-yellow-500",
                "count_tokens": "border-gray-600"
            };
            const borderColor = agentColors[agentName] || "border-gray-500";

            return (
                <div className="flex flex-col border-r border-gray-800/50">
                    {/* Agent Ê†áÁ≠æË°å */}
                    <div className="h-[120px] flex-shrink-0 px-4 py-2 text-center border-b border-gray-700 flex flex-col justify-center">
                        <div className="text-[11px] font-bold text-gray-400 truncate">{agentName}</div>
                        <div className="text-[9px] text-gray-600">{calls.length} calls</div>
                    </div>

                    {/* Ê≥≥ÈÅìÂå∫ÂüüÔºàÁ´ñÂêëÔºâ*/}
                    <div className={`swimlane-lane flex-1 border-t-4 ${borderColor} px-4 relative min-w-[120px]`}>
                        <div className="absolute left-1/2 top-0 bottom-0 w-[2px] bg-gray-800/30"></div>

                        {/* Ë∞ÉÁî®ËäÇÁÇπÔºàÁ´ñÂêëÊéíÂàóÔºåÂ∏¶ session È¢úËâ≤Ôºâ*/}
                        <div className="relative h-full">
                            {callsWithSession.map((call, idx) => (
                                <CallNode
                                    key={idx}
                                    call={call}
                                    isActive={activeCall && activeCall._sortIdx === call._sortIdx}
                                    onClick={() => onCallClick(call)}
                                    position={getGlobalPosition(call._sortIdx)}
                                    sessionColor={call.sessionColor}
                                    vertical={true}
                                    horizontalPos={call.horizontalPos}
                                />
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // Êó∂Èó¥ËΩ¥ÁªÑ‰ª∂ÔºàÁ´ñÂêëÔºâ
        const TimeAxis = ({ timeRange }) => {
            if (!timeRange) return null;

            const ticks = [];
            const tickCount = 8;
            for (let i = 0; i <= tickCount; i++) {
                const timestamp = timeRange.start + (timeRange.duration * i / tickCount);
                const position = (i / tickCount) * 100;
                ticks.push({ timestamp, position });
            }

            return (
                <div className="relative w-32 border-r border-gray-700 bg-[#1a1a1a] flex flex-col flex-shrink-0">
                    <div className="h-[120px] flex-shrink-0 border-b border-gray-700"></div>
                    <div className="flex-1 relative">
                        {ticks.map((tick, idx) => (
                            <div
                                key={idx}
                                className="absolute left-0 right-0 border-t border-gray-700/30"
                                style={{ top: `${tick.position}%` }}
                            >
                                <div className="absolute left-2 top-2 text-[9px] text-gray-500 whitespace-nowrap">
                                    {new Date(tick.timestamp * 1000).toLocaleTimeString()}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Ê≥≥ÈÅìÂõæ‰∏ªÁªÑ‰ª∂ÔºàÁ´ñÂêëÂ∏ÉÂ±ÄÔºâ
        const TimelineSwimlane = ({ traces, activeCall, onCallClick }) => {
            const { agentGroups, timeRange, globalIndexMap } = useMemo(() => {
                if (!traces || traces.length === 0) return { agentGroups: {}, timeRange: null, globalIndexMap: {} };

                // È¶ñÂÖà‰∏∫ÊâÄÊúâ trace ÂàõÂª∫ÂÖ®Â±ÄÁ¥¢ÂºïÊò†Â∞ÑÔºàÊéíÈô§ count_tokensÔºâ
                const indexMap = {};
                let globalIdx = 0;
                traces.forEach(trace => {
                    const agentName = extractAgentName(trace);
                    if (agentName === 'count_tokens') return;
                    indexMap[trace._sortIdx] = globalIdx++;
                });

                // Êåâ agent ÂàÜÁªÑÔºåËøáÊª§Êéâ count_tokens
                const groups = {};
                traces.forEach(trace => {
                    const agentName = extractAgentName(trace);
                    // Ë∑≥Ëøá count_tokens
                    if (agentName === 'count_tokens') return;

                    if (!groups[agentName]) groups[agentName] = [];
                    groups[agentName].push(trace);
                });

                // ËÆ°ÁÆóÊó∂Èó¥ËåÉÂõ¥
                const times = traces.map(t => t.timestamp);
                const range = {
                    start: Math.min(...times),
                    end: Math.max(...times),
                    duration: Math.max(...times) - Math.min(...times)
                };

                return { agentGroups: groups, timeRange: range, globalIndexMap: indexMap };
            }, [traces]);

            if (Object.keys(agentGroups).length === 0) {
                return <div className="p-10 text-gray-500 text-center">No data to display</div>;
            }

            return (
                <div className="flex flex-row h-full bg-[#1e1e1e]">
                    <TimeAxis timeRange={timeRange} />
                    <div className="flex-1 overflow-auto flex flex-row">
                        {Object.entries(agentGroups).map(([agentName, calls]) => (
                            <SwimlaneLane
                                key={agentName}
                                agentName={agentName}
                                calls={calls}
                                activeCall={activeCall}
                                onCallClick={onCallClick}
                                timeRange={timeRange}
                                globalIndexMap={globalIndexMap}
                            />
                        ))}
                    </div>
                </div>
            );
        };

        // ============= ÂéüÊúâÁªÑ‰ª∂ =============

        const ToolItem = ({ tool }) => {
            const [expanded, setExpanded] = useState(false);
            return (
                <div className="border border-gray-700 bg-[#252526] rounded-md overflow-hidden mb-2">
                    <div
                        className="px-4 py-2 border-b border-gray-700 bg-[#2d2d2d] flex justify-between items-center cursor-pointer hover:bg-[#363636] transition-colors"
                        onClick={() => setExpanded(!expanded)}
                    >
                        <div className="flex items-center gap-2 overflow-hidden">
                            <span className="opacity-50 text-[10px] w-4 text-center">{expanded ? "‚ñº" : "‚ñ∂"}</span>
                            <div className="font-bold text-teal-400 font-mono text-xs truncate">{tool.name}</div>
                            {!expanded && (
                                <div className="text-gray-500 text-[10px] truncate ml-2 max-w-[300px]">
                                    {tool.description ? tool.description.split('\n')[0] : ''}
                                </div>
                            )}
                        </div>
                    </div>
                    {expanded && (
                        <div className="p-4 space-y-3 bg-[#202020]">
                            <div className="text-gray-300 text-[11px] leading-relaxed whitespace-pre-wrap">{tool.description}</div>
                            <div className="mt-2">
                                <div className="text-[9px] uppercase tracking-wider text-gray-500 font-bold mb-1">Input Schema</div>
                                <pre className="bg-[#151515] p-2 rounded border border-gray-800 text-[10px] text-teal-200/70 font-mono overflow-x-auto">
                                    {JSON.stringify(tool.input_schema, null, 2)}
                                </pre>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ToolList = ({ tools }) => {
            if (!tools || tools.length === 0) return <div className="p-5 text-gray-500 italic">No tools defined.</div>;
            return (
                <div className="p-4 bg-[#1a1a1a]">
                    {tools.map((tool, idx) => (
                        <ToolItem key={idx} tool={tool} />
                    ))}
                </div>
            );
        };

        const ContentBlock = ({ block }) => {
            if (block.type === "text") {
                if (block.text.includes("<system-reminder>")) {
                     return (
                        <div className="text-[11px] text-amber-500/90 bg-amber-900/10 p-4 rounded-lg border border-amber-900/30 whitespace-pre-wrap font-mono leading-relaxed relative overflow-hidden my-2">
                            <div className="absolute top-0 left-0 w-1 h-full bg-amber-600/50"></div>
                            <div className="mb-2 font-bold opacity-70 flex items-center gap-2">
                                <span className="text-amber-500">‚ö†</span> SYSTEM REMINDER
                            </div>
                            {block.text}
                        </div>
                    );
                }
                return <div className="text-[13px] leading-relaxed text-gray-300 whitespace-pre-wrap">{block.text}</div>;
            }

            if (block.type === "tool_use") {
                if (block.name === "Write") {
                    const filePath = block.input.file_path || "unknown";
                    const fileName = filePath.split("/").pop();
                    const content = block.input.content || "";

                    return (
                        <div className="mt-4 border border-teal-900/40 bg-[#161616] rounded-lg overflow-hidden border-l-4 border-l-teal-600 shadow-lg">
                            <div className="bg-teal-900/10 px-4 py-2 flex items-center justify-between border-b border-teal-900/20">
                                <div className="flex items-center gap-2">
                                    <span className="text-teal-500 text-[10px] font-black uppercase">üìÑ WRITE FILE</span>
                                    <span className="text-teal-200/50 text-[11px] font-mono">/ {fileName}</span>
                                </div>
                                <span className="text-[9px] text-gray-600 font-mono hidden sm:block truncate max-w-[200px]">{filePath}</span>
                            </div>
                            <div className="relative group">
                                <pre className="p-5 font-mono text-[12px] leading-relaxed text-teal-100/80 overflow-x-auto custom-scrollbar"><code>{content}</code></pre>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="mt-4 border border-purple-900/40 bg-[#1a1a1a] rounded-lg overflow-hidden">
                        <div className="bg-purple-900/10 px-4 py-2 text-[10px] font-mono font-bold flex items-center gap-2 border-b border-purple-900/20">
                            <span className="text-purple-400">üõ† TOOL CALL:</span>
                            <span className="text-purple-200">{block.name}</span>
                        </div>
                        <div className="p-4 font-mono text-[11px] text-purple-200/70 overflow-x-auto whitespace-pre-wrap">
                            {JSON.stringify(block.input, null, 2)}
                        </div>
                    </div>
                );
            }

            if (block.type === "tool_result") {
                let contentDisplay = block.content;
                if (Array.isArray(block.content)) {
                    contentDisplay = block.content.map(c => (typeof c === "string" ? c : (c.text || JSON.stringify(c)))).join("\n");
                } else if (typeof block.content === "object" && block.content !== null) {
                    contentDisplay = JSON.stringify(block.content, null, 2);
                }

                return (
                    <div className="mt-4 p-3 bg-green-900/5 border border-green-900/20 rounded-lg text-[11px] text-green-400/80 font-mono flex items-start gap-2">
                        <span className="mt-0.5 text-green-500">‚úî</span>
                        <span className="whitespace-pre-wrap">{contentDisplay || "Success"}</span>
                    </div>
                );
            }

            if (block.type === "thinking") {
                return (
                    <div className="mt-2 mb-4 border-l-2 border-gray-600 pl-4 py-1">
                        <div className="text-[10px] uppercase font-bold text-gray-500 mb-1 flex items-center gap-2">
                            <span>üí≠</span> THINKING PROCESS
                        </div>
                        <div className="text-[12px] text-gray-400 italic leading-relaxed whitespace-pre-wrap font-serif opacity-80">
                            {block.thinking}
                        </div>
                    </div>
                );
            }

            if (block.type === "redacted_thinking") {
                 return (
                    <div className="mt-2 mb-4 border-l-2 border-gray-700 pl-4 py-1">
                        <div className="text-[10px] uppercase font-bold text-gray-600 mb-1">
                            üí≠ THINKING PROCESS (REDACTED)
                        </div>
                    </div>
                );
            }

            return <div className="text-red-500 text-[10px]">Unknown block type: {block.type}</div>;
        };

        // ËØ¶ÊÉÖÈù¢ÊùøÁªÑ‰ª∂
        const DetailPanel = ({ call, traces }) => {
            const [showSystem, setShowSystem] = useState(false);
            const [showTools, setShowTools] = useState(false);

            if (!call) {
                return (
                    <div className="flex items-center justify-center h-full text-gray-500 text-center p-10">
                        <div>
                            <div className="text-4xl mb-4">üëà</div>
                            <div className="text-sm">Select a call from the timeline</div>
                        </div>
                    </div>
                );
            }

            const activeData = useMemo(() => {
                const systemPrompt = call.request_body.system;
                const messages = [...call.request_body.messages];

                if (call.response_body) {
                    let assistantContent = null;
                    if (call.response_body.content) assistantContent = call.response_body.content;
                    else if (call.response_body.reconstructed_text) assistantContent = [{ type: "text", text: call.response_body.reconstructed_text }];

                    if (assistantContent) {
                        messages.push({ role: "assistant", content: assistantContent });
                    }
                }

                // ÊâæÂá∫Âêå‰∏Ä‰∏™ agent ÁöÑÂâç‰∏Ä‰∏™Ë∞ÉÁî®ÔºåËØÜÂà´ÂéÜÂè≤Ê∂àÊÅØÂíåÂΩìÂâçÊ∂àÊÅØ
                let historyEndIndex = -1;
                const currentAgent = extractAgentName(call);
                const currentSessionId = extractSessionId(call);

                // ÊâæÂà∞Ââç‰∏Ä‰∏™Âêå session Âêå agent ÁöÑË∞ÉÁî®
                const prevCall = traces
                    .filter(t => t._sortIdx < call._sortIdx)
                    .filter(t => extractAgentName(t) === currentAgent)
                    .filter(t => extractSessionId(t) === currentSessionId)
                    .sort((a, b) => b._sortIdx - a._sortIdx)[0];

                if (prevCall && prevCall.request_body.messages) {
                    // Ââç‰∏Ä‰∏™Ë∞ÉÁî®ÁöÑÊ∂àÊÅØÊï∞ÈáèÂ∞±ÊòØÂéÜÂè≤Ê∂àÊÅØÁöÑÁªìÊùü‰ΩçÁΩÆ
                    historyEndIndex = prevCall.request_body.messages.length - 1;
                }

                return {
                    systemPrompt: Array.isArray(systemPrompt) ? systemPrompt.map(s => s.text).join("\n") : (typeof systemPrompt === 'string' ? systemPrompt : JSON.stringify(systemPrompt)),
                    messages: messages,
                    tools: call.request_body.tools || [],
                    timestamp: call.timestamp,
                    model: call.request_body.model || "unknown",
                    historyEndIndex: historyEndIndex
                };
            }, [call, traces]);

            return (
                <div className="flex flex-col h-full bg-[#1e1e1e]">
                    {/* ËØ¶ÊÉÖÂ§¥ÈÉ® */}
                    <div className="p-4 border-b border-gray-800 bg-[#252526]">
                        <div className="flex items-center justify-between mb-2">
                            <div className="text-[10px] font-bold text-gray-500 tracking-wider uppercase">Call Details</div>
                            <div className="flex items-center bg-blue-900/20 border border-blue-800/30 rounded px-2 py-1">
                                <span className="text-[9px] font-bold text-blue-400 mr-2 uppercase">Model</span>
                                <span className="text-[10px] font-mono text-blue-200">{activeData.model}</span>
                            </div>
                        </div>
                        <div className="flex items-center gap-4 text-[11px] text-gray-400">
                            <div>
                                <span className="text-gray-600">Call #</span>
                                <span className="text-white ml-1">{call._sortIdx + 1}</span>
                            </div>
                            <div>
                                <span className="text-gray-600">Branch</span>
                                <span className="text-white ml-1">{call.branchId}</span>
                            </div>
                            <div>
                                <span className="text-gray-600">Messages</span>
                                <span className="text-white ml-1">{call.request_body.messages.length}</span>
                            </div>
                            <div className="text-gray-500">{new Date(call.timestamp * 1000).toLocaleString()}</div>
                        </div>
                    </div>

                    {/* ÂÜÖÂÆπÂå∫Âüü */}
                    <div className="flex-1 overflow-y-auto p-6 space-y-6">
                        {activeData.systemPrompt && (
                            <div className="border border-gray-700 rounded-md bg-[#2d2d2d] overflow-hidden shadow-lg">
                                <button onClick={() => setShowSystem(!showSystem)} className="w-full p-3 text-left bg-[#333] hover:bg-[#3c3c3c] font-bold text-[10px] uppercase text-blue-400 flex justify-between items-center transition-colors">
                                    <span className="flex items-center gap-2">
                                        <span className="opacity-50 text-[8px]">{showSystem ? "‚ñº" : "‚ñ∂"}</span>
                                        SYSTEM PROMPT
                                    </span>
                                </button>
                                {showSystem && <div className="p-5 text-[11px] leading-relaxed text-gray-400 border-t border-gray-700 bg-[#1a1a1a] whitespace-pre-wrap font-mono">{activeData.systemPrompt}</div>}
                            </div>
                        )}

                        <div className="border border-gray-700 rounded-md bg-[#2b2b2b] overflow-hidden shadow-lg">
                            <button onClick={() => setShowTools(!showTools)} className="w-full p-3 text-left bg-[#2f2f2f] hover:bg-[#383838] font-bold text-[10px] uppercase text-teal-400 flex justify-between items-center transition-colors">
                                <span className="flex items-center gap-2">
                                    <span className="opacity-50 text-[8px]">{showTools ? "‚ñº" : "‚ñ∂"}</span>
                                    TOOL DEFINITIONS
                                    <span className="ml-2 text-gray-500 text-[9px] normal-case font-normal">({activeData.tools.length} tools)</span>
                                </span>
                            </button>
                            {showTools && (
                                <div className="border-t border-gray-700 max-h-[400px] overflow-y-auto">
                                    <ToolList tools={activeData.tools} />
                                </div>
                            )}
                        </div>

                        <div className="space-y-8 pb-10">
                            {activeData.messages.map((msg, idx) => {
                                // Âà§Êñ≠ÊòØÂê¶ÊòØÂéÜÂè≤Ê∂àÊÅØ
                                const isHistory = activeData.historyEndIndex >= 0 && idx <= activeData.historyEndIndex;
                                const isCurrentTurn = !isHistory;

                                return (
                                    <div key={idx} className={`flex ${msg.role === "user" ? "justify-end" : "justify-start"}`}>
                                        <div className={`bubble rounded-xl overflow-hidden ${msg.role === "user" ? "bg-[#2b3a42]/30 border border-blue-900/40" : "bg-[#252526] border border-gray-800 shadow-xl"} ${isHistory ? "opacity-60" : ""}`}>
                                            <div className={`px-4 py-1.5 text-[9px] font-black uppercase tracking-widest border-b flex justify-between items-center ${msg.role === "user" ? "border-blue-900/20 text-blue-500" : "border-gray-800 text-gray-600"}`}>
                                                <div className="flex items-center gap-2">
                                                    <span>{msg.role}</span>
                                                    {isHistory && <span className="text-[8px] bg-gray-700/50 px-2 py-0.5 rounded text-gray-400">üìú History</span>}
                                                    {isCurrentTurn && idx > activeData.historyEndIndex && <span className="text-[8px] bg-green-700/50 px-2 py-0.5 rounded text-green-300">‚ú® Current</span>}
                                                    <span className="opacity-40 font-normal normal-case tracking-normal ml-2">{new Date(activeData.timestamp * 1000).toLocaleTimeString()}</span>
                                                </div>
                                            </div>
                                            <div className="p-5">
                                                {Array.isArray(msg.content) ? (
                                                    <div className="space-y-4">
                                                        {msg.content.map((b, i) => <ContentBlock key={i} block={b} />)}
                                                    </div>
                                                ) : (
                                                    <div className="text-[13px] leading-relaxed text-gray-300 whitespace-pre-wrap">{msg.content}</div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // ‰∏ªÂ∫îÁî®ÁªÑ‰ª∂
        const App = () => {
            const [traces, setTraces] = useState([]);
            const [activeCall, setActiveCall] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [dataFile, setDataFile] = useState(getDataFile());
            const [files, setFiles] = useState([]);

            useEffect(() => {
                fetch("/api/sessions")
                    .then(r => r.json())
                    .then(fileList => {
                        setFiles(fileList);
                        if (!dataFile && fileList.length > 0) setDataFile(fileList[0]);
                    })
                    .catch(() => setFiles([]));
            }, []);

            useEffect(() => {
                if (!dataFile) return;
                setLoading(true);
                setError(null);
                setTraces([]);
                setActiveCall(null);

                fetch(`/api/sessions/${dataFile}`)
                    .then(r => r.json())
                    .then(j => {
                        if (Array.isArray(j)) {
                            const chatCalls = j.filter(call =>
                                call.url.includes("/v1/messages") &&
                                call.request_body &&
                                call.request_body.messages
                            );

                            if (chatCalls.length > 0) {
                                // Add original index for stable sorting
                                chatCalls.forEach((call, i) => call._sortIdx = i);

                                // Keep original order (don't sort by timestamp to avoid timing errors)
                                // chatCalls are already in the order from the JSON file

                                // ÁÆÄÂåñÁâàÊú¨ÔºöË∑≥ËøáÂàÜÊîØÂêàÂπ∂ÔºåÊØè‰∏™Ë∞ÉÁî®‰Ωú‰∏∫Áã¨Á´ãtrace
                                const processedTraces = chatCalls.map((call, idx) => ({
                                    ...call,
                                    branchId: idx + 1,
                                    isTip: true,
                                    isNewBranch: true
                                }));

                                setTraces(processedTraces);
                                if (processedTraces.length > 0) {
                                    setActiveCall(processedTraces[0]);
                                }
                            } else {
                                setError("No chat messages found in trace.");
                            }
                        } else {
                            setError("Invalid data format (expected array)");
                        }
                        setLoading(false);
                    })
                    .catch(e => { setError(e.message); setLoading(false); });
            }, [dataFile]);

            const handleFileChange = (event) => {
                const next = event.target.value;
                setDataFile(next);
                const params = new URLSearchParams(window.location.search);
                params.set("file", next);
                window.history.replaceState({}, "", `${window.location.pathname}?${params.toString()}`);
            };

            if (loading) return <div className="p-10 text-blue-400 animate-pulse text-center tracking-widest text-xs font-bold font-mono">LOADING TIMELINE...</div>;
            if (error) return <div className="p-10 text-red-500 text-center font-bold font-mono">ERROR: {error}</div>;

            return (
                <div className="flex flex-col h-full bg-[#1e1e1e]">
                    {/* È°∂ÈÉ®ÂØºËà™Ê†è */}
                    <div className="p-4 border-b border-gray-800 bg-[#252526] flex justify-between items-center z-50">
                        <div className="flex items-center gap-3">
                            <div className="w-3 h-3 rounded-full bg-[#ff5f56]"></div>
                            <div className="w-3 h-3 rounded-full bg-[#ffbd2e]"></div>
                            <div className="w-3 h-3 rounded-full bg-[#27c93f]"></div>
                            <h1 className="ml-2 text-[10px] font-bold text-gray-500 tracking-[0.2em] uppercase">Claude Timeline Swimlane</h1>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="text-[11px] text-gray-400">
                                <span className="text-gray-600">Total Calls:</span>
                                <span className="text-white ml-2">{traces.length}</span>
                            </div>
                            <div className="flex items-center gap-2 text-[10px] font-mono text-gray-600">
                                <span>FILE</span>
                                <select
                                    value={dataFile}
                                    onChange={handleFileChange}
                                    className="bg-[#1b1b1b] border border-gray-700/70 rounded px-2 py-1 text-gray-300 focus:outline-none focus:border-blue-600/60"
                                >
                                    {files.map(file => (
                                        <option key={file} value={file}>{file}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* ‰∏ªÂÜÖÂÆπÂå∫ÂüüÔºöÂèåÊ†èÂ∏ÉÂ±Ä */}
                    <div className="flex flex-1 overflow-hidden">
                        {/* Â∑¶‰æßÔºöÊ≥≥ÈÅìÂõæ */}
                        <div className="w-1/2 border-r border-gray-800 overflow-hidden">
                            <TimelineSwimlane
                                traces={traces}
                                activeCall={activeCall}
                                onCallClick={setActiveCall}
                            />
                        </div>

                        {/* Âè≥‰æßÔºöËØ¶ÊÉÖÈù¢Êùø */}
                        <div className="w-1/2 overflow-hidden">
                            <DetailPanel
                                call={activeCall}
                                traces={traces}
                            />
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>
