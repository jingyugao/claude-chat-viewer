<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Conversation Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #1e1e1e; color: #d4d4d4; font-family: "Menlo", "Monaco", "Courier New", monospace; }
        .bubble { max-width: 90%; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
    </style>
</head>
<body class="h-screen flex flex-col">
    <div id="root" class="flex-1 overflow-hidden"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const getDataFile = () => {
            const params = new URLSearchParams(window.location.search);
            const candidate = params.get("file");
            if (!candidate) return null;
            if (candidate.includes("/") || candidate.includes("\\") || candidate.includes("..")) {
                return null;
            }
            return candidate;
        };

        const App = () => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [showSystem, setShowSystem] = useState(false);
            const [showTools, setShowTools] = useState(false);
            const [dataFile, setDataFile] = useState(getDataFile());
            const [files, setFiles] = useState([]);
            const availableFiles = React.useMemo(() => {
                const filesWithSelected = [...files];
                if (dataFile && !filesWithSelected.includes(dataFile)) filesWithSelected.unshift(dataFile);
                return filesWithSelected;
            }, [files, dataFile]);

            useEffect(() => {
                fetch("/api/sessions")
                    .then(r => r.json())
                    .then(fileList => {
                        setFiles(fileList);
                        if (!dataFile && fileList.length > 0) setDataFile(fileList[0]);
                    })
                    .catch(() => {
                        setFiles([]);
                    });
            }, [dataFile]);

            useEffect(() => {
                if (!dataFile) return;
                setLoading(true);
                setError(null);
                setData(null);
                fetch(`/api/sessions/${dataFile}`)
                    .then(r => r.json())
                    .then(j => { 
                        // ADAPTER: Convert raw API call list to viewer format
                        if (Array.isArray(j)) {
                            // Find the last successful /v1/messages call
                            const chatCalls = j.filter(call => 
                                call.url.includes("/v1/messages") && 
                                call.request_body && 
                                call.request_body.messages
                            );
                            
                            if (chatCalls.length > 0) {
                                const lastCall = chatCalls[chatCalls.length - 1];
                                const systemPrompt = lastCall.request_body.system;
                                const messages = [...lastCall.request_body.messages];
                                
                                // Append the assistant's response if available
                                if (lastCall.response_body) {
                                    let assistantContent = null;
                                    
                                    // Handle standard JSON response
                                    if (lastCall.response_body.content) {
                                        assistantContent = lastCall.response_body.content;
                                    } 
                                    // Handle reconstructed SSE text
                                    else if (lastCall.response_body.reconstructed_text) {
                                        assistantContent = [{ type: "text", text: lastCall.response_body.reconstructed_text }];
                                    }

                                    if (assistantContent) {
                                        messages.push({
                                            role: "assistant",
                                            content: assistantContent
                                        });
                                    }
                                }

                                setData({
                                    systemPrompt: Array.isArray(systemPrompt) ? systemPrompt.map(s => s.text).join("\n") : systemPrompt,
                                    messages: messages,
                                    tools: lastCall.request_body.tools || []
                                });
                            } else {
                                setError("No chat messages found in trace.");
                            }
                        } else {
                            // Fallback for legacy format
                            setData(j); 
                        }
                        setLoading(false); 
                    })
                    .catch(e => { setError(e.message); setLoading(false); });
            }, [dataFile]);

            const handleFileChange = (event) => {
                const next = event.target.value;
                setDataFile(next);
                const params = new URLSearchParams(window.location.search);
                params.set("file", next);
                window.history.replaceState({}, "", `${window.location.pathname}?${params.toString()}`);
            };

            if (loading) return <div className="p-10 text-blue-400 animate-pulse text-center tracking-widest text-xs font-bold">INITIALIZING TRACE...</div>;
            if (error) return <div className="p-10 text-red-500 text-center font-bold">ERROR: {error}</div>;
            if (!data) return <div className="p-10 text-gray-400 text-center font-bold">NO DATA FILES FOUND</div>;

            const getToolDefinitions = () => {
                if (data.toolDefinitions) return data.toolDefinitions;
                if (data.tools) return data.tools;
                if (data.systemPrompt) {
                    const start = data.systemPrompt.indexOf("<tools>");
                    const end = data.systemPrompt.indexOf("</tools>");
                    if (start !== -1 && end !== -1 && end > start) {
                        return data.systemPrompt.slice(start + 7, end).trim();
                    }
                }
                return null;
            };

            const ToolList = ({ tools }) => {
                if (!tools || tools.length === 0) return <div className="p-5 text-gray-500 italic">No tools defined.</div>;
                
                return (
                    <div className="grid grid-cols-1 gap-4 p-4 bg-[#1a1a1a]">
                        {tools.map((tool, idx) => (
                            <div key={idx} className="border border-gray-700 bg-[#252526] rounded-md overflow-hidden">
                                <div className="px-4 py-2 border-b border-gray-700 bg-[#2d2d2d] flex justify-between items-center">
                                    <div className="font-bold text-teal-400 font-mono text-xs">{tool.name}</div>
                                </div>
                                <div className="p-4 space-y-3">
                                    <div className="text-gray-300 text-[11px] leading-relaxed">{tool.description}</div>
                                    <div className="mt-2">
                                        <div className="text-[9px] uppercase tracking-wider text-gray-500 font-bold mb-1">Input Schema</div>
                                        <pre className="bg-[#151515] p-2 rounded border border-gray-800 text-[10px] text-teal-200/70 font-mono overflow-x-auto">
                                            {JSON.stringify(tool.input_schema, null, 2)}
                                        </pre>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                );
            };

            const toolDefs = getToolDefinitions();
            // Try to parse if it's a JSON string, otherwise assume it's an object or list
            let parsedTools = [];
            try {
                if (typeof toolDefs === 'string') {
                    // Try to extract JSON array if embedded in text
                    if (toolDefs.trim().startsWith('[')) {
                         parsedTools = JSON.parse(toolDefs);
                    }
                } else if (Array.isArray(toolDefs)) {
                    parsedTools = toolDefs;
                }
            } catch (e) {
                console.error("Failed to parse tools", e);
            }

            return (
                <div className="flex flex-col h-full max-w-6xl mx-auto border-x border-gray-800 bg-[#1e1e1e] shadow-2xl">
                    <div className="p-4 border-b border-gray-800 bg-[#252526] flex justify-between items-center sticky top-0 z-50">
                        <div className="flex items-center gap-3">
                            <div className="w-3 h-3 rounded-full bg-[#ff5f56] shadow-sm"></div>
                            <div className="w-3 h-3 rounded-full bg-[#ffbd2e] shadow-sm"></div>
                            <div className="w-3 h-3 rounded-full bg-[#27c93f] shadow-sm"></div>
                            <h1 className="ml-2 text-[10px] font-bold text-gray-500 tracking-[0.2em] uppercase">Claude Trace Inspector</h1>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="text-[10px] font-mono text-gray-600 bg-black/20 px-2 py-1 rounded">
                                {data.messages.length} EVENTS
                            </div>
                            <div className="flex items-center gap-2 text-[10px] font-mono text-gray-600">
                                <span className="hidden sm:inline">FILE</span>
                                <select
                                    value={dataFile}
                                    onChange={handleFileChange}
                                    className="bg-[#1b1b1b] border border-gray-700/70 rounded px-2 py-1 text-gray-300 focus:outline-none focus:border-blue-600/60"
                                >
                                    {availableFiles.map(file => (
                                        <option key={file} value={file}>{file}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-6 space-y-10">
                        {data.systemPrompt && (
                            <div className="border border-gray-700 rounded-md bg-[#2d2d2d] overflow-hidden shadow-lg">
                                <button onClick={() => setShowSystem(!showSystem)} className="w-full p-3 text-left bg-[#333] hover:bg-[#3c3c3c] font-bold text-[10px] uppercase text-blue-400 flex justify-between items-center transition-colors">
                                    <span className="flex items-center gap-2">
                                        <span className="opacity-50">{showSystem ? "â–¼" : "â–¶"}</span>
                                        SYSTEM PROMPT
                                    </span>
                                    <span className="text-[9px] bg-blue-900/30 text-blue-300 px-1.5 py-0.5 rounded border border-blue-800/30">READ ONLY</span>
                                </button>
                                {showSystem && <div className="p-5 text-[11px] leading-relaxed text-gray-400 border-t border-gray-700 bg-[#1a1a1a] whitespace-pre-wrap font-mono">{data.systemPrompt}</div>}
                            </div>
                        )}
                        <div className="border border-gray-700 rounded-md bg-[#2b2b2b] overflow-hidden shadow-lg">
                            <button onClick={() => setShowTools(!showTools)} className="w-full p-3 text-left bg-[#2f2f2f] hover:bg-[#383838] font-bold text-[10px] uppercase text-teal-400 flex justify-between items-center transition-colors">
                                <span className="flex items-center gap-2">
                                    <span className="opacity-50">{showTools ? "â–¼" : "â–¶"}</span>
                                    TOOL DEFINITIONS
                                    <span className="ml-2 text-gray-500 text-[9px] normal-case font-normal">({parsedTools.length} tools)</span>
                                </span>
                                <span className="text-[9px] bg-teal-900/30 text-teal-300 px-1.5 py-0.5 rounded border border-teal-800/30">READ ONLY</span>
                            </button>
                            {showTools && (
                                <div className="border-t border-gray-700 max-h-[500px] overflow-y-auto">
                                    <ToolList tools={parsedTools} />
                                </div>
                            )}
                        </div>

                        <div className="space-y-12 pb-10">
                            {data.messages.map((msg, idx) => (
                                <div key={idx} className={`flex ${msg.role === "user" ? "justify-end" : "justify-start"}`}>
                                    <div className={`bubble rounded-xl overflow-hidden ${msg.role === "user" ? "bg-[#2b3a42]/30 border border-blue-900/40" : "bg-[#252526] border border-gray-800 shadow-xl"}`}>
                                        <div className={`px-4 py-1.5 text-[9px] font-black uppercase tracking-widest border-b flex justify-between items-center ${msg.role === "user" ? "border-blue-900/20 text-blue-500" : "border-gray-800 text-gray-600"}`}>
                                            <span>{msg.role}</span>
                                            {msg.role === "assistant" && <span className="opacity-30">AI</span>}
                                        </div>
                                        <div className="p-5">
                                            {Array.isArray(msg.content) ? (
                                                <div className="space-y-4">
                                                    {msg.content.map((b, i) => <ContentBlock key={i} block={b} />)}
                                                </div>
                                            ) : (
                                                <div className="text-[13px] leading-relaxed text-gray-300 whitespace-pre-wrap">{msg.content}</div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ContentBlock = ({ block }) => {
            if (block.type === "text") {
                if (block.text.includes("<system-reminder>")) {
                     return (
                        <div className="text-[11px] text-amber-500/90 bg-amber-900/10 p-4 rounded-lg border border-amber-900/30 whitespace-pre-wrap font-mono leading-relaxed relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-1 h-full bg-amber-600/50"></div>
                            <div className="mb-2 font-bold opacity-70 flex items-center gap-2">
                                <span className="text-amber-500">âš </span> SYSTEM REMINDER
                            </div>
                            {block.text}
                        </div>
                    );
                }
                return <div className="text-[13px] leading-relaxed text-gray-300 whitespace-pre-wrap">{block.text}</div>;
            }
            
            if (block.type === "tool_use") {
                if (block.name === "Write") {
                    const filePath = block.input.file_path || "unknown";
                    const fileName = filePath.split("/").pop();
                    const content = block.input.content || "";
                    
                    return (
                        <div className="mt-4 border border-teal-900/40 bg-[#161616] rounded-lg overflow-hidden border-l-4 border-l-teal-600 shadow-lg">
                            <div className="bg-teal-900/10 px-4 py-2 flex items-center justify-between border-b border-teal-900/20">
                                <div className="flex items-center gap-2">
                                    <span className="text-teal-500 text-[10px] font-black uppercase">ðŸ“„ WRITE FILE</span>
                                    <span className="text-teal-200/50 text-[11px] font-mono">/ {fileName}</span>
                                </div>
                                <span className="text-[9px] text-gray-600 font-mono hidden sm:block truncate max-w-[200px]">{filePath}</span>
                            </div>
                            <div className="relative group">
                                <pre className="p-5 font-mono text-[12px] leading-relaxed text-teal-100/80 overflow-x-auto custom-scrollbar"><code>{content}</code></pre>
                            </div>
                        </div>
                    );
                }
                
                // Generic tool use
                return (
                    <div className="mt-4 border border-purple-900/40 bg-[#1a1a1a] rounded-lg overflow-hidden">
                        <div className="bg-purple-900/10 px-4 py-2 text-[10px] font-mono font-bold flex items-center gap-2 border-b border-purple-900/20">
                            <span className="text-purple-400">ðŸ›  TOOL CALL:</span>
                            <span className="text-purple-200">{block.name}</span>
                        </div>
                        <div className="p-4 font-mono text-[11px] text-purple-200/70 overflow-x-auto whitespace-pre-wrap">
                            {JSON.stringify(block.input, null, 2)}
                        </div>
                    </div>
                );
            }
            
            if (block.type === "tool_result") {
                // FIX: Handle structured content in tool results (e.g. array of text blocks)
                let contentDisplay = block.content;
                
                if (Array.isArray(block.content)) {
                    contentDisplay = block.content.map(c => {
                        if (typeof c === "string") return c;
                        if (c.type === "text") return c.text;
                        return JSON.stringify(c);
                    }).join("\\n");
                } else if (typeof block.content === "object" && block.content !== null) {
                    contentDisplay = JSON.stringify(block.content, null, 2);
                }

                return (
                    <div className="mt-4 p-3 bg-green-900/5 border border-green-900/20 rounded-lg text-[11px] text-green-400/80 font-mono flex items-start gap-2">
                        <span className="mt-0.5">âœ”</span> 
                        <span className="whitespace-pre-wrap">{contentDisplay || "Success"}</span>
                    </div>
                );
            }
            
            return <div className="text-red-500 text-[10px]">Unknown block type: {block.type}</div>;
        };

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>
